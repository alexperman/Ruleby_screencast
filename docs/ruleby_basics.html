<!DOCTYPE html>  <html> <head>   <title>LHS_examples.rb</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               LHS_examples.rb             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>An alarm system.</h1>

<p>To fully use Ruleby, the main point is to know precisely :</p>

<ol>
<li>how to write LHS, <em>Left Hand Side</em>, the conditionnal part of a rule.  </li>
<li>how to work with a facts databases. </li>
</ol>

<p>The courrent DSL to write LHS should change in the future, but let's talk of how it works today.</p>

<p>Let's demonstrate this with rules for an alarm system for a fabric or computer room. First if someone push the alarm button, bell rings.</p>

<h2>A simple (but wrong way) of ringing on button push.</h2>

<p>Let say the button call method 'push' or 'release' when it changes state. The "name" is just here to show how to use binding feature :</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Add to fact a Pushed button</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">push</span>
  <span class="n">assert</span><span class="p">(</span> <span class="no">Button</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;alarm&quot;</span><span class="p">,</span> <span class="ss">:status</span><span class="o">=&gt;</span><span class="ss">:pushed</span><span class="p">)</span> <span class="p">)</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Add to fact a Released button</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">release</span>
  <span class="n">assert</span><span class="p">(</span> <span class="no">Button</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;alarm&quot;</span><span class="p">,</span> <span class="ss">:status</span><span class="o">=&gt;</span><span class="ss">:released</span><span class="p">)</span> <span class="p">)</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The rule that process pushed buttons. No priority for this 1st exemple</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">rule</span> <span class="ss">:buttonPush</span><span class="p">,</span> </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Here, you <strong>need</strong> to understand that <code>method</code> is in fact the instance of Button that is currently matched against this pattern.
you can prononce it like :</p>

<blockquote>
  <p><em>When I get Button event, I associate it with :button key of context, I call its method <code>name</code> and associate the result to
    :button_name key of context, I check if its method <code>status</code> return <code>:pushed</code>. If yes, launch action.</em> </p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="o">[</span><span class="no">Button</span><span class="p">,</span><span class="ss">:button</span><span class="p">,{</span><span class="nb">method</span><span class="o">.</span><span class="n">name</span><span class="o">=&gt;</span><span class="ss">:button_name</span><span class="p">},</span> <span class="nb">method</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="ss">:pushed</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">context</span><span class="o">|</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Here we acces to value binded to the context hash</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">button</span>      <span class="o">=</span> <span class="n">context</span><span class="o">[</span><span class="ss">:button</span><span class="o">]</span>
    <span class="n">button_name</span> <span class="o">=</span> <span class="n">context</span><span class="o">[</span><span class="ss">:button_name</span><span class="o">]</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Name can be used to log</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="no">Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Button </span><span class="si">#{</span><span class="n">button_name</span><span class="si">}</span><span class="s2"> push handled at </span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Here we will need to define this "start_ringing" better... but one step at a time.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">start_ringing</span><span class="p">()</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Same kind of rule for button release. We do not use button_name here to show an other way of accessing object</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">rule</span> <span class="ss">:buttonRelease</span><span class="p">,</span> 
  <span class="o">[</span><span class="no">Button</span><span class="p">,</span><span class="ss">:button</span><span class="p">,</span> <span class="nb">method</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="ss">:released</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">context</span><span class="o">|</span>
    <span class="n">button</span>      <span class="o">=</span> <span class="n">context</span><span class="o">[</span><span class="ss">:button</span><span class="o">]</span>
    <span class="no">Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Button </span><span class="si">#{</span><span class="n">button</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> release handled at </span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>    </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>But... wait ! There is a start and a stop, maybe this mean there is a kind of "state", ie : is_ringing, for the ring ? .</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">stop_ringing</span><span class="p">()</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2>Why is this wrong ?</h2>

<p>In this example facts are only added. After one push and one release you will find in the fact database two <code>Button</code> objects.
One pushed, the other one released which is an inconsistent state. Furthermore the ring state is not handled but left to mystery 
of <code>start_ringing</code> and <code>stop_ringing</code>. What if we want to write rules that use the ringing state ?
1st things, let's clean fact database. We have two possibilities.</p>

<h3>retract facts in the rules.</h3>

<p>This is something we have to know, but maybe not the best thing to do here. Exemple with the buttonRelease rule</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">rule</span> <span class="ss">:buttonRelease</span><span class="p">,</span> 
  <span class="o">[</span><span class="no">Button</span><span class="p">,</span><span class="ss">:button</span><span class="p">,</span> <span class="nb">method</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="ss">:released</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">context</span><span class="o">|</span>
    <span class="n">button</span>      <span class="o">=</span> <span class="n">context</span><span class="o">[</span><span class="ss">:button</span><span class="o">]</span>
    <span class="no">Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Button </span><span class="si">#{</span><span class="n">button</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> release handled at </span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>    </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>But... wait ! There is a start and a stop, maybe this mean there is a kind of "state", ie : is_ringing, for the ring ? .</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">stop_ringing</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Here we do :</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">retract</span> <span class="n">button</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h3>Maintain a external state.</h3>

<p>You may think "The button is an external device and thus should be handled by an external object". Well, I would say "handle this technique with care" ! 
Sharing state between rule engine and the external word is really something risky if done improperly. The way of doing it is to keep a ref 
to the state objet, let's use a wrapping object to do it well, then tell the rule engine after each modification. 
In this exemple the name <code>Button</code> is kept for the class, even if <code>ButtonState</code> would be more appropriate.
I am just using a feature of common developpers called <em>Laziness</em> which lead them to deploy incredible way of working with code they had 
made unclear this way. In this case this avoid me changin slighlty the above rules's LHS. This is the typical kind of case where you really
should avoid handling external states... But this technique is sometime the most adapted to a situation (Please send me correction proposal if you disagree with this). </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">ButtonInterface</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">button_name</span><span class="p">,</span> <span class="n">rule_engine</span><span class="p">)</span>
    <span class="vi">@button</span> <span class="o">=</span> <span class="no">Button</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">button_name</span><span class="p">,</span> <span class="ss">:status</span><span class="o">=&gt;</span><span class="ss">:released</span><span class="p">)</span>
    <span class="vi">@engine</span> <span class="o">=</span> <span class="n">rule_engine</span>
    <span class="vi">@engine</span><span class="o">.</span><span class="n">assert</span> <span class="vi">@button</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">push</span>
    <span class="vi">@button</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="ss">:pushed</span>
    <span class="vi">@engine</span><span class="o">.</span><span class="n">modify</span> <span class="vi">@button</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">release</span>
    <span class="vi">@button</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="ss">:released</span>
    <span class="vi">@engine</span><span class="o">.</span><span class="n">modify</span> <span class="vi">@button</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h3>Maintain an internal state in facts database</h3>

<p>Ok, here we are ! What is behind this idea ? Guess ?
If you hold a state in facts database, why would you send to the rule engine an other state ? Why not just handle "Events" and let the rule engine manage states consistently inside itself ? 
Let see next chapter.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h1>Splitting states and events.</h1>

<p>In this exemple Button convey a state and is used when something change... It is used as an event ! 
What we could do is :
* Change states (and send engine.modify) inside rules. 
* Use simple rules which can handle events and change states if needed. </p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 